name: "Terraform — Azure Deploy (Debug & Apply)"

on:
  push:
    branches:
      - main

env:
  TF_WORKING_DIR: '.'            # The folder where your root .tf files are
  TF_PLAN_FILE: 'tfplan.bin'     # Name of the plan file

jobs:
  terraform:
    name: Plan & Apply with Debug
    runs-on: windows-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate module directories
        shell: pwsh
        run: |
          Write-Host "Checking modules/vnet and modules/windows-vm existence"
          if (-not (Test-Path "./modules/vnet")) {
            Write-Error "❌ Module folder ./modules/vnet does not exist!"
            exit 1
          }
          if (-not (Test-Path "./modules/windows-vm")) {
            Write-Error "❌ Module folder ./modules/windows-vm does not exist!"
            exit 1
          }
          Write-Host "✅ Module directories found."

      - name: Debug file structure
        shell: pwsh
        run: |
          Write-Host "=== Root directory listing ==="
          dir .\ -Recurse
          Write-Host "=== Modules directory listing ==="
          dir .\modules -Recurse

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Clean Terraform cache
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          if (Test-Path .terraform) {
            Remove-Item -Recurse -Force .terraform
          }
          if (Test-Path .terraform.lock.hcl) {
            Remove-Item .terraform.lock.hcl
          }
          Write-Host "✅ Cleaned Terraform cache."

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          terraform init `
            -backend-config="resource_group_name=${{ secrets.AZURE_RESOURCE_GROUP }}" `
            -backend-config="storage_account_name=${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            -backend-config="container_name=${{ secrets.AZURE_CONTAINER_NAME }}" `
            -backend-config="key=${{ secrets.AZURE_STATE_KEY }}"

      - name: Post-init modules folder check
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          Write-Host "=== modules directory after init ==="
          dir .\modules -Recurse

      - name: Terraform Format Check
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          terraform plan `
            -out=${{ env.TF_PLAN_FILE }} `
            -var="admin_password=${{ secrets.ADMIN_PASSWORD }}" `
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" `
            -input=false

      - name: Show Terraform Plan (text)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform show ${TF_PLAN_FILE}

      - name: Export Plan JSON
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform show -json ${TF_PLAN_FILE} > plan.json

      - name: Upload plan.json
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-json
          path: plan.json

      - name: Inspect Plan JSON Summary
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          $json = Get-Content -Raw plan.json | ConvertFrom-Json
          Write-Host "===== Plan JSON Summary ====="
          if ($null -eq $json.module_calls) {
            Write-Host "module_calls is null or empty"
          } else {
            Write-Host "Modules recognized: " + ($json.module_calls.Keys -join ", ")
          }
          if ($null -eq $json.resource_changes) {
            Write-Host "resource_changes is null or empty"
          } else {
            Write-Host "Number of resource_changes: $($json.resource_changes.Count)"
            foreach ($rc in $json.resource_changes) {
              Write-Host (" • Address: $($rc.address) | Actions: " + ($rc.change.actions -join ", "))
            }
          }

      - name: Terraform Apply (Conditional)
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          $json = Get-Content -Raw plan.json | ConvertFrom-Json
          if ($null -eq $json.resource_changes -or $json.resource_changes.Count -eq 0) {
            Write-Host "ℹ️ No resource changes detected; skipping apply."
            exit 0
          } else {
            terraform apply -auto-approve ${TF_PLAN_FILE}
          }

      - name: Debug State & Outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "--- Terraform State List ---"
          terraform state list || echo "(no state)"
          echo "--- Terraform Outputs ---"
          terraform output || echo "(no outputs)"

      - name: Dump All Outputs JSON
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          Write-Host "=== Terraform outputs (JSON) ==="
          $raw = terraform output -json
          if ($raw) {
            $obj = $raw | ConvertFrom-Json
            $obj | ConvertTo-Json -Depth 5
          } else {
            Write-Host "No outputs returned (raw JSON empty)."
          }

      - name: Validate subnet_id output
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: pwsh
        run: |
          $subnetId = terraform output -raw subnet_id 2>$null
          Write-Host "Subnet ID (raw): '$subnetId'"
          if ([string]::IsNullOrEmpty($subnetId)) {
            Write-Error "❌ subnet_id output is empty — VNet module may not have been created or output defined incorrectly."
            exit 1
          } else {
            Write-Host "✅ Subnet ID: $subnetId"
          }

      - name: Show VM Outputs
       
